From: Tim Lunn <tim@feathertop.org>
Date: Sat, 22 Mar 2014 10:23:12 +1100
Subject: Add hook to run prime-offload (as root) move Prime helpers into the
 gdm-x-session wrapper

---
 common/gdm-common.c    |  2 +-
 daemon/gdm-display.c   |  1 +
 daemon/gdm-x-session.c | 10 ++++++++++
 data/Makefile.am       | 24 ++++++++++++++++++++++++
 data/Prime             |  6 ++++++
 data/PrimeOff          |  6 ++++++
 6 files changed, 48 insertions(+), 1 deletion(-)
 create mode 100644 data/Prime
 create mode 100644 data/PrimeOff

diff --git a/common/gdm-common.c b/common/gdm-common.c
index effd4bc..a01531e 100644
--- a/common/gdm-common.c
+++ b/common/gdm-common.c
@@ -990,7 +990,7 @@ gdm_run_script (const char *dir,
                 goto out;
         }
 
-        env = gdm_get_script_environment (username,
+        env = gdm_get_script_environment ((g_strcmp0 (username, "root") == 0)?NULL:username,
                                           display_name,
                                           display_hostname,
                                           display_x11_authority_file);
diff --git a/daemon/gdm-display.c b/daemon/gdm-display.c
index 20cda93..e83b198 100644
diff --git a/daemon/gdm-x-session.c b/daemon/gdm-x-session.c
index 3cc7d40..a801ace 100644
--- a/daemon/gdm-x-session.c
+++ b/daemon/gdm-x-session.c
@@ -169,6 +169,11 @@ on_x_server_finished (GSubprocess  *subprocess,
         if (cancelled) {
                 goto out;
         }
+        gdm_run_script (GDMCONFDIR "/PrimeOff", "root",
+                       state->display_name,
+                       NULL, /* hostname */
+                       state->auth_file);
+
 
         if (g_subprocess_get_if_exited (subprocess)) {
                 int exit_status;
@@ -499,6 +504,11 @@ spawn_session (State        *state,
 
         g_debug ("Running X session");
 
+        gdm_run_script (GDMCONFDIR "/Prime", "root",
+                        state->display_name,
+                        NULL, /* hostname */
+                        state->auth_file);
+
         launcher = g_subprocess_launcher_new (G_SUBPROCESS_FLAGS_NONE);
 
         g_subprocess_launcher_setenv (launcher, "DISPLAY", state->display_name, TRUE);
diff --git a/data/Makefile.am b/data/Makefile.am
index 7d521bb..7cd0c7e 100644
--- a/data/Makefile.am
+++ b/data/Makefile.am
@@ -10,6 +10,8 @@ SUBDIRS =			\
 initdir = $(gdmconfdir)/Init
 postdir = $(gdmconfdir)/PostSession
 predir = $(gdmconfdir)/PreSession
+primedir = $(gdmconfdir)/Prime
+primeoffdir = $(gdmconfdir)/PrimeOff
 postlogindir = $(gdmconfdir)/PostLogin
 workingdir = $(GDM_WORKING_DIR)
 xauthdir = $(GDM_XAUTH_DIR)
@@ -154,6 +156,8 @@ EXTRA_DIST +=			\
 	Xsession.in 		\
 	Init.in 		\
 	PreSession.in 		\
+	Prime			\
+	PrimeOff      		\
 	PostSession.in 		\
 	PostLogin 		\
 	org.gnome.login-screen.gschema.xml.in \
@@ -204,6 +208,8 @@ uninstall-hook:
 	$(DESTDIR)$(initdir)/Default \
 	$(DESTDIR)$(postlogindir)/Default.sample \
 	$(DESTDIR)$(predir)/Default \
+	$(DESTDIR)$(primedir)/Default \
+	$(DESTDIR)$(primeoffdir)/Default \
 	$(DESTDIR)$(postdir)/Default \
 	$(DESTDIR)$(sysconfdir)/dconf/db/gdm \
 	$(DESTDIR)$(sysconfdir)/dconf/profile/gdm \
@@ -254,6 +260,24 @@ install-data-hook: gdm.conf-custom Xsession Init PostSession PreSession $(system
 	fi
 	$(INSTALL_SCRIPT) PreSession $(DESTDIR)$(predir)/Default
 
+	if test '!' -d $(DESTDIR)$(primedir); then \
+		$(mkinstalldirs) $(DESTDIR)$(primedir); \
+		chmod 755 $(DESTDIR)$(primedir); \
+	fi
+	-if test -f $(DESTDIR)$(primedir)/Default; then \
+		cp -f $(DESTDIR)$(primedir)/Default $(DESTDIR)$(primedir)/Default.orig; \
+	fi
+	$(INSTALL_SCRIPT) Prime $(DESTDIR)$(primedir)/Default
+
+	if test '!' -d $(DESTDIR)$(primeoffdir); then \
+		$(mkinstalldirs) $(DESTDIR)$(primeoffdir); \
+		chmod 755 $(DESTDIR)$(primeoffdir); \
+	fi
+	-if test -f $(DESTDIR)$(primeoffdir)/Default; then \
+		cp -f $(DESTDIR)$(primeoffdir)/Default $(DESTDIR)$(primeoffdir)/Default.orig; \
+	fi
+	$(INSTALL_SCRIPT) PrimeOff $(DESTDIR)$(primeoffdir)/Default
+
 	if test '!' -d $(DESTDIR)$(postdir); then \
 		$(mkinstalldirs) $(DESTDIR)$(postdir); \
 		chmod 755 $(DESTDIR)$(postdir); \
diff --git a/data/Prime b/data/Prime
new file mode 100644
index 0000000..30caf03
--- /dev/null
+++ b/data/Prime
@@ -0,0 +1,6 @@
+#!/bin/sh
+
+primeoffload=/sbin/prime-offload
+if [ -f "$primeoffload" ]; then
+    $primeoffload
+fi
diff --git a/data/PrimeOff b/data/PrimeOff
new file mode 100644
index 0000000..5a61c3c
--- /dev/null
+++ b/data/PrimeOff
@@ -0,0 +1,6 @@
+#!/bin/sh
+
+primeswitch=/sbin/prime-switch
+if [ -f "$primeswitch" ]; then
+    $primeswitch
+fi
