#!/usr/bin/make -f

include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/class/gnome.mk
include /usr/share/cdbs/1/rules/patchsys-quilt.mk
include /usr/share/gnome-pkg-tools/1/rules/uploaders.mk
include /usr/share/gnome-pkg-tools/1/rules/gnome-version.mk
-include /usr/share/gnome-pkg-tools/1/rules/gnome-get-source.mk

DEB_CONFIGURE_EXTRA_FLAGS += --disable-scrollkeeper \
		--enable-ipv6=yes \
		--with-at-spi-registryd-directory=/usr/lib/at-spi \
		--with-default-path=/usr/local/bin:/usr/bin:/bin:/usr/games \
		--with-custom-conf=/etc/gdm/daemon.conf

ifeq (linux,$(DEB_HOST_ARCH_OS))
	DEB_CONFIGURE_EXTRA_FLAGS += --with-selinux
endif


DEB_DH_INSTALLINIT_ARGS := --noscripts

binary-install/gdm::
	chmod 755 debian/gdm/usr/share/gdm/gdmXnestWrapper
	mv debian/gdm/usr/sbin/gdm-binary debian/gdm/usr/sbin/gdm
	cd debian/gdm/usr/sbin && rm -f gdm-restart gdm-stop gdm-safe-restart
	chmod 755 debian/gdm/etc/gdm/Xsession
	dh_installpam -pgdm --name=gdm-autologin
	rm -rf debian/gdm/var/lib/gdm/.g*
	rm -rf debian/gdm/var/run
	cd debian/gdm/usr/share/gdm/greeter-config && \
		mv session-setup.entries 10_upstream.entries


MANPAGES := $(patsubst %.pod,%,$(wildcard debian/*.pod))

common-build-arch:: $(MANPAGES)

clean::
	rm -f $(MANPAGES)

%: %.pod
	pod2man --section=$(shell echo $@ | sed 's/.*\.//') \
		--release="GNOME $(DEB_GNOME_VERSION)" \
		--center="Debian GNU/Linux" \
		$< \
		| sed -e 's/debian:://' >$@
