GNOME #645918

Index: gdm-3.4.1/daemon/gdm-server.c
===================================================================
--- gdm-3.4.1.orig/daemon/gdm-server.c	2012-06-20 20:53:20.643879549 +0200
+++ gdm-3.4.1/daemon/gdm-server.c	2012-06-20 20:53:20.679879718 +0200
@@ -142,7 +142,7 @@ _gdm_server_query_ck_for_display_device
         g_return_val_if_fail (GDM_IS_SERVER (server), NULL);
 
         error = NULL;
-        command = g_strdup_printf (LIBEXECDIR "/ck-get-x11-display-device --display %s",
+        command = g_strdup_printf (CK_LIBEXECDIR "/ck-get-x11-display-device --display %s",
                                    server->priv->display_name);
 
         g_debug ("GdmServer: Running helper %s", command);
Index: gdm-3.4.1/gui/simple-chooser/gdm-chooser-session.c
===================================================================
--- gdm-3.4.1.orig/gui/simple-chooser/gdm-chooser-session.c	2012-06-20 20:53:13.515844704 +0200
+++ gdm-3.4.1/gui/simple-chooser/gdm-chooser-session.c	2012-06-20 20:53:20.679879718 +0200
@@ -131,7 +131,7 @@ start_settings_daemon (GdmChooserSession
         ret = FALSE;
 
         error = NULL;
-        g_spawn_command_line_async (LIBEXECDIR "/gnome-settings-daemon", &error);
+        g_spawn_command_line_async (GSD_BINARY, &error);
         if (error != NULL) {
                 g_warning ("Error starting settings daemon: %s", error->message);
                 g_error_free (error);
Index: gdm-3.4.1/configure.ac
===================================================================
--- gdm-3.4.1.orig/configure.ac	2012-06-20 20:53:20.611879386 +0200
+++ gdm-3.4.1/configure.ac	2012-06-20 20:53:20.679879718 +0200
@@ -67,6 +67,7 @@ LIBCANBERRA_GTK_REQUIRED_VERSION=0.4
 FONTCONFIG_REQUIRED_VERSION=2.5.0
 UPOWER_REQUIRED_VERSION=0.9.0
 ACCOUNTS_SERVICE_REQUIRED_VERSION=0.6.12
+GSD_REQUIRED_VERSION=2.91.2
 NSS_REQUIRED_VERSION=3.11.1
 
 EXTRA_COMPILE_WARNINGS(yes)
@@ -187,6 +188,34 @@ LIBGDMGREETER_GIR_INCLUDES="GLib-2.0 GOb
 AC_SUBST(LIBGDMGREETER_GIR_INCLUDES)
 
 dnl ---------------------------------------------------------------------------
+dnl - Paths for dependencies
+dnl ---------------------------------------------------------------------------
+
+PKG_CHECK_MODULES(GSD,
+        gnome-settings-daemon >= $GSD_REQUIRED_VERSION
+)
+GSD_BINARY=`pkg-config --variable=binary gnome-settings-daemon`
+AC_SUBST(GSD_BINARY)
+
+dnl This should be done with pkg-config, but ConsoleKit doesn't
+dnl ship .pc files
+dnl Because of that we only handle the case where libexecdir is the same
+dnl (e.g. Red Hat), and the case where libexecdir = pkglibdir (e.g. Debian)
+
+AC_MSG_CHECKING(where helpers are installed)
+if test x`basename "$libexecdir"` = "xlibexec"; then
+        AC_MSG_RESULT($libexecdir)
+        CK_LIBEXECDIR="$libexecdir"
+        SESSION_LIBEXECDIR="$libexecdir"
+else
+        AC_MSG_RESULT("$libdir/Consolekit")
+        CK_LIBEXECDIR="$libdir/ConsoleKit"
+        SESSION_LIBEXECDIR="$libdir/gnome-session"
+fi
+AC_SUBST(CK_LIBEXECDIR)
+AC_SUBST(SESSION_LIBEXECDIR)
+
+dnl ---------------------------------------------------------------------------
 dnl - Configuration file stuff
 dnl ---------------------------------------------------------------------------
 
Index: gdm-3.4.1/daemon/Makefile.am
===================================================================
--- gdm-3.4.1.orig/daemon/Makefile.am	2012-06-20 20:53:13.515844704 +0200
+++ gdm-3.4.1/daemon/Makefile.am	2012-06-20 20:53:20.679879718 +0200
@@ -12,6 +12,7 @@ AM_CPPFLAGS = \
 	-DGDMCONFDIR=\"$(gdmconfdir)\"			\
 	-DLIBDIR=\"$(libdir)\"				\
 	-DLIBEXECDIR=\"$(libexecdir)\"			\
+	-DCK_LIBEXECDIR=\"$(CK_LIBEXECDIR)\"			\
 	-DLOGDIR=\"$(logdir)\"				\
 	-DSBINDIR=\"$(sbindir)\"			\
 	-DGNOMELOCALEDIR=\""$(datadir)/locale"\"	\
Index: gdm-3.4.1/gui/simple-chooser/Makefile.am
===================================================================
--- gdm-3.4.1.orig/gui/simple-chooser/Makefile.am	2012-06-20 20:53:13.515844704 +0200
+++ gdm-3.4.1/gui/simple-chooser/Makefile.am	2012-06-20 20:53:20.679879718 +0200
@@ -12,6 +12,7 @@ AM_CPPFLAGS = \
 	-DSBINDIR=\""$(sbindir)"\"		 	\
 	-DPIXMAPDIR=\""$(pixmapdir)"\"		 	\
 	-DAT_SPI_REGISTRYD_DIR="\"$(AT_SPI_REGISTRYD_DIR)\""	\
+	-DGSD_BINARY="\"$(GSD_BINARY)\""		\
 	$(GTK_CFLAGS)					\
 	$(XLIB_CFLAGS)					\
 	$(XDMCP_CFLAGS)					\
Index: gdm-3.4.1/data/Makefile.am
===================================================================
--- gdm-3.4.1.orig/data/Makefile.am	2012-06-20 20:53:13.515844704 +0200
+++ gdm-3.4.1/data/Makefile.am	2012-06-20 20:53:20.679879718 +0200
@@ -79,7 +79,7 @@ gdm.schemas.in: $(srcdir)/gdm.schemas.in
 		<$(srcdir)/gdm.schemas.in.in >gdm.schemas.in
 
 gdm-shell.session: $(srcdir)/gdm-shell.session.in
-	sed	-e 's,[@]libexecdir[@],$(libexecdir),g' \
+	sed	-e 's,[@]SESSION_LIBEXECDIR[@],$(SESSION_LIBEXECDIR),g' \
 		< $(srcdir)/gdm-shell.session.in > gdm-shell.session
 
 localealiasdir = $(datadir)/gdm
Index: gdm-3.4.1/data/gdm-shell.session.in
===================================================================
--- gdm-3.4.1.orig/data/gdm-shell.session.in	2012-06-20 20:53:11.635835509 +0200
+++ gdm-3.4.1/data/gdm-shell.session.in	2012-06-20 20:53:44.015993807 +0200
@@ -1,5 +1,5 @@
 [GNOME Session]
 Name=Display Manager
 RequiredComponents=gnome-shell;gnome-settings-daemon;
-IsRunnableHelper=bash -c 'gnome-shell --help | grep -q gdm-mode && @libexecdir@/gnome-session-check-accelerated'
+IsRunnableHelper=bash -c 'gnome-shell --help | grep -q gdm-mode && @SESSION_LIBEXECDIR@/gnome-session-check-accelerated'
 FallbackSession=gdm-fallback
