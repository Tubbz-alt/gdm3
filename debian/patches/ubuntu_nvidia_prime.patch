From: Tim Lunn <tim@feathertop.org>
Date: Sat, 22 Mar 2014 10:23:12 +1100
Subject: Add hook to run prime-offload (as root) move Prime helpers into the
 gdm-x-session wrapper

---
 common/gdm-common.c    |  2 +-
 daemon/gdm-display.c   |  1 +
 daemon/gdm-x-session.c | 10 ++++++++++
 data/Makefile.am       | 24 ++++++++++++++++++++++++
 data/Prime             |  6 ++++++
 data/PrimeOff          |  6 ++++++
 6 files changed, 48 insertions(+), 1 deletion(-)
 create mode 100644 data/Prime
 create mode 100644 data/PrimeOff

Index: gdm3-3.26.0/common/gdm-common.c
===================================================================
--- gdm3-3.26.0.orig/common/gdm-common.c	2017-09-14 08:24:10.584748891 -0400
+++ gdm3-3.26.0/common/gdm-common.c	2017-09-14 08:24:10.580748834 -0400
@@ -677,7 +677,7 @@ gdm_run_script (const char *dir,
                 goto out;
         }
 
-        env = gdm_get_script_environment (username,
+        env = gdm_get_script_environment ((g_strcmp0 (username, "root") == 0)?NULL:username,
                                           display_name,
                                           display_hostname,
                                           display_x11_authority_file);
Index: gdm3-3.26.0/daemon/gdm-x-session.c
===================================================================
--- gdm3-3.26.0.orig/daemon/gdm-x-session.c	2017-09-14 08:24:10.584748891 -0400
+++ gdm3-3.26.0/daemon/gdm-x-session.c	2017-09-14 08:24:10.580748834 -0400
@@ -172,6 +172,11 @@ on_x_server_finished (GSubprocess  *subp
         if (cancelled) {
                 goto out;
         }
+        gdm_run_script (GDMCONFDIR "/PrimeOff", "root",
+                       state->display_name,
+                       NULL, /* hostname */
+                       state->auth_file);
+
 
         if (g_subprocess_get_if_exited (subprocess)) {
                 int exit_status;
@@ -614,6 +619,11 @@ spawn_session (State        *state,
 
         g_debug ("Running X session");
 
+        gdm_run_script (GDMCONFDIR "/Prime", "root",
+                        state->display_name,
+                        NULL, /* hostname */
+                        state->auth_file);
+
         launcher = g_subprocess_launcher_new (G_SUBPROCESS_FLAGS_NONE);
 
         if (state->environment != NULL) {
Index: gdm3-3.26.0/data/Makefile.am
===================================================================
--- gdm3-3.26.0.orig/data/Makefile.am	2017-09-14 08:24:10.584748891 -0400
+++ gdm3-3.26.0/data/Makefile.am	2017-09-14 08:24:10.584748891 -0400
@@ -10,6 +10,8 @@ SUBDIRS =			\
 initdir = $(gdmconfdir)/Init
 postdir = $(gdmconfdir)/PostSession
 predir = $(gdmconfdir)/PreSession
+primedir = $(gdmconfdir)/Prime
+primeoffdir = $(gdmconfdir)/PrimeOff
 postlogindir = $(gdmconfdir)/PostLogin
 workingdir = $(GDM_WORKING_DIR)
 xauthdir = $(GDM_XAUTH_DIR)
@@ -172,6 +174,8 @@ EXTRA_DIST +=			\
 	Xsession.in 		\
 	Init.in 		\
 	PreSession.in 		\
+	Prime			\
+	PrimeOff      		\
 	PostSession.in 		\
 	PostLogin 		\
 	org.gnome.login-screen.gschema.xml.in \
@@ -236,6 +240,8 @@ uninstall-hook:
 	$(DESTDIR)$(initdir)/Default \
 	$(DESTDIR)$(postlogindir)/Default.sample \
 	$(DESTDIR)$(predir)/Default \
+	$(DESTDIR)$(primedir)/Default \
+	$(DESTDIR)$(primeoffdir)/Default \
 	$(DESTDIR)$(postdir)/Default \
 	$(DESTDIR)$(sysconfdir)/dconf/db/gdm \
 	$(DESTDIR)$(sysconfdir)/dconf/profile/gdm \
@@ -282,6 +288,24 @@ endif
 	fi
 	$(INSTALL_SCRIPT) PreSession $(DESTDIR)$(predir)/Default
 
+	if test '!' -d $(DESTDIR)$(primedir); then \
+		$(mkinstalldirs) $(DESTDIR)$(primedir); \
+		chmod 755 $(DESTDIR)$(primedir); \
+	fi
+	-if test -f $(DESTDIR)$(primedir)/Default; then \
+		cp -f $(DESTDIR)$(primedir)/Default $(DESTDIR)$(primedir)/Default.orig; \
+	fi
+	$(INSTALL_SCRIPT) Prime $(DESTDIR)$(primedir)/Default
+
+	if test '!' -d $(DESTDIR)$(primeoffdir); then \
+		$(mkinstalldirs) $(DESTDIR)$(primeoffdir); \
+		chmod 755 $(DESTDIR)$(primeoffdir); \
+	fi
+	-if test -f $(DESTDIR)$(primeoffdir)/Default; then \
+		cp -f $(DESTDIR)$(primeoffdir)/Default $(DESTDIR)$(primeoffdir)/Default.orig; \
+	fi
+	$(INSTALL_SCRIPT) PrimeOff $(DESTDIR)$(primeoffdir)/Default
+
 	if test '!' -d $(DESTDIR)$(postdir); then \
 		$(mkinstalldirs) $(DESTDIR)$(postdir); \
 		chmod 755 $(DESTDIR)$(postdir); \
Index: gdm3-3.26.0/data/Prime
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ gdm3-3.26.0/data/Prime	2017-09-14 08:24:10.584748891 -0400
@@ -0,0 +1,6 @@
+#!/bin/sh
+
+primeoffload=/sbin/prime-offload
+if [ -f "$primeoffload" ]; then
+    $primeoffload
+fi
Index: gdm3-3.26.0/data/PrimeOff
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ gdm3-3.26.0/data/PrimeOff	2017-09-14 08:24:10.584748891 -0400
@@ -0,0 +1,6 @@
+#!/bin/sh
+
+primeswitch=/sbin/prime-switch
+if [ -f "$primeswitch" ]; then
+    $primeswitch
+fi
