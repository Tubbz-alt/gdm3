From ac2948efe420f17c8a34c16fba33296d930f740d Mon Sep 17 00:00:00 2001
From: Martin Pitt <martin.pitt@ubuntu.com>
Date: Fri, 6 Aug 2010 12:21:47 +0200
Subject: [PATCH 3/3] Port to UPower

DeviceKit-Power has been renamed to UPower in January 2010.
devkit-power-gobject is deprecated and will be removed in future versions of
UPower.

Bug: https://bugzilla.gnome.org/show_bug.cgi?id=626176
---
 configure.ac                           |   21 +++++++++++----------
 gui/simple-greeter/Makefile.am         |    7 +++----
 gui/simple-greeter/gdm-greeter-panel.c |   30 ++++++++++++++----------------
 3 files changed, 28 insertions(+), 30 deletions(-)

Index: gdm-2.30.4/configure.ac
===================================================================
--- gdm-2.30.4.orig/configure.ac	2010-06-29 15:42:25.000000000 +0200
+++ gdm-2.30.4/configure.ac	2010-08-06 12:55:39.409012996 +0200
@@ -50,7 +50,7 @@
 LIBCANBERRA_GTK_REQUIRED_VERSION=0.4
 #FONTCONFIG_REQUIRED_VERSION=2.6.0
 FONTCONFIG_REQUIRED_VERSION=2.5.0
-DEVKIT_POWER_REQUIRED_VERSION=008
+UPOWER_REQUIRED_VERSION=0.9.0
 
 EXTRA_COMPILE_WARNINGS(yes)
 
@@ -103,17 +103,17 @@
 AC_SUBST(GCONF_CFLAGS)
 AC_SUBST(GCONF_LIBS)
 
-PKG_CHECK_MODULES(DEVKIT_POWER,
-        devkit-power-gobject >= $DEVKIT_POWER_REQUIRED_VERSION,
-        have_devicekit_power=yes,
-        have_devicekit_power=no
+PKG_CHECK_MODULES(UPOWER,
+        upower-glib >= $UPOWER_REQUIRED_VERSION,
+        have_upower=yes,
+        have_upower=no
 )
-if test "x$have_devicekit_power" = "xyes" ; then
-  AC_DEFINE(HAVE_DEVICEKIT_POWER, [], [Define if we have DeviceKit-power])
+if test "x$have_upower" = "xyes" ; then
+  AC_DEFINE(HAVE_UPOWER, [], [Define if we have UPower])
 fi
-AC_SUBST(HAVE_DEVICEKIT_POWER)
-AC_SUBST(DEVKIT_POWER_CFLAGS)
-AC_SUBST(DEVKIT_POWER_LIBS)
+AC_SUBST(UPOWER)
+AC_SUBST(UPOWER_CFLAGS)
+AC_SUBST(UPOWER_LIBS)
 
 PKG_CHECK_MODULES(SIMPLE_GREETER,
         dbus-glib-1 >= $DBUS_GLIB_REQUIRED_VERSION
@@ -1463,5 +1463,6 @@
         XDMCP support:            ${XDMCP_SUPPORT}
         SELinux support:          ${with_selinux}
         ConsoleKit support:       ${use_console_kit}
+        UPower support:           ${have_upower}
         Build with RBAC:          ${msg_rbac_shutdown}
 "
Index: gdm-2.30.4/gui/simple-greeter/Makefile.am
===================================================================
--- gdm-2.30.4.orig/gui/simple-greeter/Makefile.am	2010-06-29 15:42:14.000000000 +0200
+++ gdm-2.30.4/gui/simple-greeter/Makefile.am	2010-08-06 12:55:39.409012996 +0200
@@ -18,8 +18,7 @@
 	-DSBINDIR=\""$(sbindir)"\"		 	\
 	-DGDM_CACHE_DIR=\""$(localstatedir)/cache/gdm"\"	\
 	-DAT_SPI_REGISTRYD_DIR="\"$(AT_SPI_REGISTRYD_DIR)\""	\
-	$(DEVKIT_POWER_CFLAGS)				\
-	-DI_KNOW_THE_DEVICEKIT_POWER_API_IS_SUBJECT_TO_CHANGE	\
+	$(UPOWER_CFLAGS)				\
 	$(DISABLE_DEPRECATED_CFLAGS)			\
 	$(GTK_CFLAGS)					\
 	$(SIMPLE_GREETER_CFLAGS)			\
@@ -143,7 +142,7 @@
 	$(GTK_LIBS)			\
 	$(GCONF_LIBS)			\
 	$(LIBXKLAVIER_LIBS)		\
-	$(DEVKIT_POWER_LIBS)		\
+	$(UPOWER_LIBS)		\
 	$(NULL)
 
 test_remote_login_window_SOURCES = 	\
@@ -331,7 +330,7 @@
 	$(SIMPLE_GREETER_LIBS)		\
 	$(RBAC_LIBS)			\
 	$(LIBXKLAVIER_LIBS)		\
-	$(DEVKIT_POWER_LIBS)		\
+	$(UPOWER_LIBS)		\
 	$(NULL)
 
 uidir = $(pkgdatadir)
Index: gdm-2.30.4/gui/simple-greeter/gdm-greeter-panel.c
===================================================================
--- gdm-2.30.4.orig/gui/simple-greeter/gdm-greeter-panel.c	2010-06-26 00:09:31.000000000 +0200
+++ gdm-2.30.4/gui/simple-greeter/gdm-greeter-panel.c	2010-08-06 12:55:39.419012997 +0200
@@ -40,8 +40,8 @@
 #include <gconf/gconf-client.h>
 #include <dbus/dbus-glib.h>
 
-#ifdef HAVE_DEVICEKIT_POWER
-#include <devkit-power-gobject/devicekit-power.h>
+#ifdef HAVE_UPOWER
+#include <upower.h>
 #endif
 
 #include "gdm-languages.h"
@@ -551,15 +551,13 @@
 {
         gboolean ret = FALSE;
 
-#ifdef HAVE_DEVICEKIT_POWER
-        DkpClient *dkp_client;
+#ifdef HAVE_UPOWER
+        UpClient *up_client;
 
-        /* use DeviceKit-power to get data */
-        dkp_client = dkp_client_new ();
-        g_object_get (dkp_client,
-                      "can-suspend", &ret,
-                      NULL);
-        g_object_unref (dkp_client);
+        /* use UPower to get data */
+        up_client = up_client_new ();
+	ret = up_client_get_can_suspend (up_client);
+        g_object_unref (up_client);
 #endif
 
         return ret;
@@ -568,20 +566,20 @@
 static void
 do_system_suspend (void)
 {
-#ifdef HAVE_DEVICEKIT_POWER
+#ifdef HAVE_UPOWER
         gboolean ret;
-        DkpClient *dkp_client;
+        UpClient *up_client;
         GError *error = NULL;
 
-        /* use DeviceKit-power to get data */
-        dkp_client = dkp_client_new ();
-        ret = dkp_client_suspend (dkp_client, &error);
+        /* use UPower to trigger suspend */
+        up_client = up_client_new ();
+        ret = up_client_suspend_sync (up_client, NULL, &error);
         if (!ret) {
                 g_warning ("Couldn't suspend: %s", error->message);
                 g_error_free (error);
                 return;
         }
-        g_object_unref (dkp_client);
+        g_object_unref (up_client);
 #endif
 }
 
